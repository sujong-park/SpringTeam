<!doctype html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/base.html}">
<head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
              integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
              crossorigin="anonymous">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            align-items: center;
            width: 100vw;
            height: 100vh;
            background-color: #f5f5f5;
        }

        .chat-container {
            display: flex;
            width: 100%;
        }

        .chat-list {
            width: 30%;
            background-color: #ffffff;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            position: relative;
        }

        .chat-list-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            background-color: #f9f9f9;
        }

        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        .search-container {
            display: inline-block;
            margin-left: 10px;
            margin-right: 10px;
        }

        .search-container input {
            width: 100px;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .chat-list-item {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-list-item:hover {
            background-color: #f9f9f9;
        }

        .room-info-modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ddd;
            margin-right: 15px;
        }

        .chat-preview {
            flex: 1;
        }

        .chat-preview h4 {
            margin: 0 0 5px;
            font-size: 16px;
            color: #333;
        }

        .chat-preview p {
            margin: 0;
            font-size: 14px;
            color: #777;
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            font-size: 18px;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* ë©”ì‹œì§€ê°€ ì•„ë˜ì—ì„œ ìœ„ë¡œ ì˜¬ë¼ê°€ê²Œ */
        }

        .message {
            margin: 10px 0;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-content {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .message.other .message-content {
            background-color: #f0f0f0;
            color: #333;
        }

        .chat-input {
            padding: 10px;
            display: flex;
            border-top: 1px solid #ddd;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
        }

        .chat-input button {
            margin-left: 10px;
            padding: 10px 20px;
            font-size: 14px;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-input button:hover {
            background-color: #0056b3;
        }

        .friend-list, .create-room-user-list{
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 20px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .friend-item:hover {
            background-color: #eef;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .friend-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            appearance: none;
            border: 2px solid #007bff;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .friend-item input[type="checkbox"]:checked {
            background-color: #007bff;
            border-color: #0056b3;
        }

        .friend-item label {
            flex: 1;
            margin-left: 15px;
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="chat-container">
        <!-- ì±„íŒ…ë°© ëª©ë¡ ì‹œì‘ -->
        <div class="chat-list">
            <div class="chat-list-header">
                <!-- ì±„íŒ…ë°© ê²€ìƒ‰ ì…ë ¥ë€ -->
                <div class="search-container" id="searchContainer">
                    <form action="/chatingRoom/roomList" method="get" id="searchForm">
                        <input type="text" name="keyword" placeholder="ì±„íŒ…ë°© ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..." th:value="${keyword}">
                    </form>
                </div>
                <!-- ì±„íŒ…ë°© ìƒì„± ë²„íŠ¼ -->
                <button class="icon-button" id="addButton">â•</button>
            </div>
            <!-- ì±„íŒ…ë°© ì •ë³´ ë°˜ë³µ ì¶œë ¥ -->
            <div th:each="room : ${roomList}" class="chatInfo">
                <div class="chat-avatar"></div>
                <div class="chat-preview">
                    <!-- ë°©ë²ˆí˜¸, í˜¸ìŠ¤íŠ¸ë²ˆí˜¸ (ìˆ¨ê¹€) -->
                    <h4 th:text="${room.roomId}" hidden="hidden">ë°©ë²ˆí˜¸</h4>
                    <h4 th:text="${room.hostId}" hidden="hidden">í˜¸ìŠ¤íŠ¸ë²ˆí˜¸</h4>
                    <!-- ì±„íŒ…ë°© ì œëª© ë° ì¸ì›ìˆ˜ -->
                    <h4 th:text="${room.title}">ì±„íŒ…ë°© ì œëª©</h4>
                    <span th:text="${room.currentParticipants + ' / ' + room.maxParticipants}">0 / 0</span>
                    <!-- ì±„íŒ…ë°© ì„¤ëª… -->
                    <p th:text="${room.description}">ì±„íŒ…ë°© ì„¤ëª…</p>
                    <h4 th:text="${room.status}" hidden="hidden">ìƒíƒœ</h4>
                    <h4 th:text="${room.currentParticipants}" hidden="hidden">í˜„ì¬ì¸ì›</h4>
                    <h4 th:text="${room.maxParticipants}" hidden="hidden">ìµœëŒ€ì¸ì›</h4>
                </div>
            </div>
        </div>
        <!-- ì±„íŒ…ë°© ëª©ë¡ ë -->

        <!-- ì±„íŒ…ì°½ ì‹œì‘ -->
        <div class="chat-window">
            <div class="chat-header">
                ì±„íŒ…ë°©
                <!-- ì¹œêµ¬ ì´ˆëŒ€ ë²„íŠ¼ -->
                <button class="icon-button" id="inviteButton" title="ì¹œêµ¬ ì´ˆëŒ€">ğŸ‘¥</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- ì±„íŒ… ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
            <div class="chat-input">
                <input type="text" id="chatMessageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="sendMessageButton">ì „ì†¡</button>
            </div>
        </div>
        <!-- ì±„íŒ…ì°½ ë -->

        <!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ ì‹œì‘ -->
        <div class="modal fade registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="registerModalLabel">ì±„íŒ…ë°© ìƒì„±</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ë°© ì œëª©, ì„¤ëª…, ìµœëŒ€ ì¸ì› ì…ë ¥ -->
                        <div class="mb-3">
                            <label for="title" class="form-label">ë°© ì œëª©</label>
                            <input type="text" class="form-control title" id="title" />
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">ì„¤ëª…</label>
                            <input type="text" class="form-control description" id="description" />
                        </div>
                        <div class="mb-3">
                            <label for="maxParticipants" class="form-label">ìµœëŒ€ ì¸ì›</label>
                            <input type="number" class="form-control maxParticipants" id="maxParticipants" />
                        </div>
                        <!-- ìœ ì € ê²€ìƒ‰ ë° ì„ íƒ -->
                        <div class="mb-3">
                            <input type="text" class="form-control" id="createRoomSearchUser" placeholder="ì´ˆëŒ€í•  ìœ ì € ê²€ìƒ‰" />
                        </div>
                        <div class="create-room-user-list friend-list">
                            <!-- ìœ ì € ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary registerBtn">ë°© ìƒì„±</button>
                        <button type="button" class="btn btn-secondary registerCloseBtn" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ ë -->

        <!-- ì±„íŒ…ë°© ì •ë³´ ëª¨ë‹¬ ì‹œì‘ -->
        <div class="modal fade roomInfoModal" tabindex="-1" aria-labelledby="roomInfoModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="roomInfoModalLabel">ë°© ì •ë³´</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center room-info-modal-body">
                        <div class="chat-avatar"></div>
                        <h4 class="room-title"></h4>
                        <p class="room-participants"></p>
                        <p class="room-description"></p>
                    </div>
                    <!-- ëª¨ë‹¬ í•˜ë‹¨ ë²„íŠ¼ë“¤ -->
                    <div class="modal-footer">
                        <!-- ìˆ˜ì •, ì‚­ì œ, ë‹«ê¸° ë²„íŠ¼ (í˜¸ìŠ¤íŠ¸ì¼ ë•Œë§Œ í‘œì‹œ) -->
                        <button type="button" class="btn btn-danger room-delete-btn" style="display: none;">ì‚­ì œ</button>
                        <button type="button" class="btn btn-warning room-edit-btn" style="display: none;">ìˆ˜ì •</button>
                        <!-- ë‚˜ê°€ê¸°, ë‹«ê¸° ë²„íŠ¼ (ì¼ë°˜ ì‚¬ìš©ìê°€ ë“¤ì–´ê°”ì„ ë•Œ í‘œì‹œ) -->
                        <button type="button" class="btn btn-danger room-leave-btn" style="display: none;">ë°© ë‚˜ê°€ê¸°</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ì±„íŒ…ë°© ì •ë³´ ëª¨ë‹¬ ë -->

        <!-- ì±„íŒ…ë°© ìˆ˜ì • ëª¨ë‹¬ ì‹œì‘ -->
        <div class="modal fade editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">ì±„íŒ…ë°© ìˆ˜ì •</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ë°© ì´ë¦„, ì„¤ëª…, ìµœëŒ€ì¸ì›, ìƒíƒœ ìˆ˜ì • ì…ë ¥ -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">ë°© ì´ë¦„</span>
                            <input type="text" class="form-control edit-title">
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">ì„¤ëª…</span>
                            <input type="text" class="form-control edit-description">
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">ìµœëŒ€ì¸ì›</span>
                            <input type="number" class="form-control edit-maxParticipants">
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">ìƒíƒœ</span>
                            <select class="form-select edit-status">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary editCloseBtn">ë‹«ê¸°</button>
                        <button type="button" class="btn btn-primary editBtn">ìˆ˜ì • ì™„ë£Œ</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ì±„íŒ…ë°© ìˆ˜ì • ëª¨ë‹¬ ë -->

        <!-- ì¹œêµ¬ ëª©ë¡ ì´ˆëŒ€ ëª¨ë‹¬ ì‹œì‘ -->
        <div class="modal fade inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <!-- í—¤ë”: ê²€ìƒ‰ ê¸°ëŠ¥ -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="inviteModalLabel">ì¹œêµ¬ ì´ˆëŒ€</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ê²€ìƒ‰ ì…ë ¥ -->
                        <div class="search-bar mb-3">
                            <input type="text" class="form-control" id="searchUser" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <!-- ìœ ì € ëª©ë¡ -->
                        <div class="friend-list overflow-auto" style="max-height: 400px;">
                            <!-- ìœ ì € ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    <!-- í‘¸í„°: ì´ˆëŒ€ ë° ë‹«ê¸° ë²„íŠ¼ -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary inviteBtn">ì´ˆëŒ€</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ì¹œêµ¬ ëª©ë¡ ì´ˆëŒ€ ëª¨ë‹¬ ë -->
    </div>

    <!-- JavaScript í¬í•¨ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/chatingRoom.js"></script>
</div>

<script layout:fragment="javascript" th:inline="javascript">
    //ë¡œê·¸ì¸í•œ ìœ ì €ì˜ Idë¥¼ ê°€ì ¸ì˜¨ë‹¤.
    const currentUser = [[${#authentication.principal.username}]];

    // ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ê³¼ ê´€ë ¨ëœ ìš”ì†Œ
    const registerModal = new bootstrap.Modal(document.querySelector(".registerModal"));
    const registerBtn = document.querySelector(".registerBtn");
    const registerCloseBtn = document.querySelector(".registerCloseBtn");

    //ì±„íŒ…ë°© ì •ë³´ ì…ë ¥ ë€
    const title = document.querySelector(".title");
    const description = document.querySelector(".description");
    const maxParticipants = document.querySelector(".maxParticipants");

    // ìœ ì € ê²€ìƒ‰ ë° ë Œë”ë§ ê´€ë ¨ ë³€ìˆ˜
    const userSearchInput = document.querySelector("#createRoomSearchUser");
    const userListContainer = document.querySelector(".create-room-user-list");
    let selectedUsers = [];

    // ìœ ì € ê²€ìƒ‰ ì´ë²¤íŠ¸(ìœ ì €ê°€ ì…ë ¥í• ë•Œë§ˆë‹¤ í˜¸ì¶œë˜ì–´ ìœ ì € ëª©ë¡ì„ ê°±ì‹ )
    userSearchInput.addEventListener("input", async function () {
        const keyword = userSearchInput.value.trim();
        try {
            //ìœ ì € ëª©ë¡ì¡°íšŒ
            const userList = await getUserListCreate(currentUser, keyword);
            //ìœ ì €ëª©ë¡ì„ í™”ë©´ì— ìƒì„±
            renderCreateRoomUserList(userList);
        } catch (error) {
            console.error("ìœ ì € ê²€ìƒ‰ ì‹¤íŒ¨:", error);
        }
    });

    // ìœ ì € ëª©ë¡ ë Œë”ë§(ìœ ì € ëª©ë¡ì„ ê²€ìƒ‰í•´ í™”ë©´ì— ëª©ë¡ìœ¼ë¡œ ìƒì„±)
    function renderCreateRoomUserList(userList) {
        userListContainer.innerHTML = "";

        if (userList.length === 0) {
            userListContainer.innerHTML = '<p class="text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        userList.forEach(user => {
            //ìœ ì €ê°€ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            const isChecked = selectedUsers.includes(user.mid);
            const userItem = document.createElement("div");

            //ì¹œêµ¬ ëª©ë¡ ìŠ¤íƒ€ì¼ ì ìš©
            userItem.classList.add("friend-item");
            userItem.innerHTML = `
            <input type="checkbox" id="user-${user.mid}" value="${user.mid}" ${isChecked ? "checked" : ""}>
            <label for="user-${user.mid}">${user.name}</label>
        `;
            userListContainer.appendChild(userItem);
        });

        // ì²´í¬ë°•ìŠ¤ ì„ íƒ ì´ë²¤íŠ¸
        userListContainer.querySelectorAll("input[type='checkbox']").forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                const userId = this.value;
                if (this.checked) {
                    console.log("ì„ íƒí•œ ìœ ì € ì •ë³´ :" + userId);
                    if (!selectedUsers.includes(userId)) {
                        //ì„ íƒëœ ìœ ì € ì¶”ê°€
                        selectedUsers.push(userId);
                    }
                } else {
                    console.log("ì„ íƒ í•´ì œí•œ ìœ ì € ì •ë³´ :" + userId);
                    //ì„ íƒ í•´ì œ
                    selectedUsers = selectedUsers.filter(id => id !== userId);
                }
            });
        });
    }

    // +ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ì„ ë„ì›€
    document.querySelector('#addButton').addEventListener('click', function () {
        console.log("ë°© ì¶”ê°€ í´ë¦­");
        registerModal.show();

        // ì´ˆê¸°í™” ë° ìœ ì € ëª©ë¡ ì¡°íšŒ
        userSearchInput.value = ''; // ê²€ìƒ‰ ì…ë ¥ ì´ˆê¸°í™”
        selectedUsers = []; // ì„ íƒ ìœ ì € ì´ˆê¸°í™”
        getUserListCreate(currentUser, '')
            .then(userList => {
                renderCreateRoomUserList(userList); // ìœ ì € ëª©ë¡ ë Œë”ë§
            })
            .catch(error => {
                console.error("ìœ ì € ê²€ìƒ‰ ì‹¤íŒ¨:", error);
            });
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    registerCloseBtn.addEventListener("click", function () {
        registerModal.hide();
    });

    // ë°© ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ
    registerBtn.addEventListener("click", function () {
        //ì„ íƒí• ë•Œë§ˆë‹¤ ìœ ì € ì •ë³´ í™•ì¸
        console.log("selectedUsers:", selectedUsers);

        // ìµœëŒ€ ì°¸ì—¬ ì¸ì› ìˆ«ìë¡œ ë³€í™˜
        const maxParticipantsValue = parseInt(maxParticipants.value, 10);
        if (isNaN(maxParticipantsValue)) {
            alert("ìµœëŒ€ ì°¸ì—¬ ì¸ì› ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        //ìµœëŒ€ ì¸ì› ìˆ˜ ì œí•œ ì²´í¬
        if (maxParticipantsValue < selectedUsers.length + 1) {
            alert("ìµœëŒ€ " + (maxParticipantsValue - 1) + "ëª…ê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ì„ íƒëœ ì¸ì›: " + selectedUsers.length + "ëª…)");
            return;
        }

        const chatingRoomDTO = {
            hostId: currentUser,
            title: title.value,
            description: description.value,
            maxParticipants: maxParticipantsValue,
            currentParticipants: selectedUsers.length + 1,
            status: "Open"
        };

        const chatRoomParticipantsDTO = [
            ...selectedUsers.map(userId => ({
                senderId: userId,
            })),
            { senderId: currentUser }
        ];

        const roomRegisterObj = {
            chatingRoomDTO,
            chatRoomParticipantsDTO
        };

        console.log("roomRegisterObj:", roomRegisterObj);

        //ì±„íŒ…ë°© ìƒì„±
        addRoom(roomRegisterObj)
            .then(result => {
                console.log("ì±„íŒ…ë°© ìƒì„± ì„±ê³µ:", result);
                alert("ì±„íŒ…ë°©ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.");
                registerModal.hide();
                location.reload();
            })
            .catch(e => {
                console.error("ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨:", e);
                alert("ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨. ì„œë²„ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.");
            });
    });

    // ì±„íŒ…ë°© ì •ë³´ ëª¨ë‹¬
    const roomInfoModal = new bootstrap.Modal(document.querySelector(".roomInfoModal"));
    const chatItems = document.querySelectorAll(".chat-avatar");

    // ì±„íŒ…ë°© ì •ë³´ë¥¼ í´ë¦­í•˜ë©´ ë°© ì •ë³´ ëª¨ë‹¬ì„ ë„ì›€
    chatItems.forEach(chatItem => {
        chatItem.addEventListener("click", function () {
            console.log("ë°© ì •ë³´ í´ë¦­")
            const roomId = this.closest(".chatInfo").querySelector("h4:nth-of-type(1)").innerText;
            const hostId = this.closest(".chatInfo").querySelector("h4:nth-of-type(2)").innerText;
            const roomTitle = this.closest(".chatInfo").querySelector("h4:nth-of-type(3)").innerText;
            const status = this.closest(".chatInfo").querySelector("h4:nth-of-type(4)").innerText;
            const currentParticipants = this.closest(".chatInfo").querySelector("h4:nth-of-type(5)").innerText;
            const maxParticipants = this.closest(".chatInfo").querySelector("h4:nth-of-type(6)").innerText;
            const roomParticipants = this.closest(".chatInfo").querySelector(".chat-preview span").innerText;
            const roomDescription = this.closest(".chatInfo").querySelector(".chat-preview p").innerText;

            //ë°© ì •ë³´ í‘œì‹œ
            document.querySelector(".room-title").innerText = roomTitle;
            document.querySelector(".room-participants").innerText = roomParticipants;
            document.querySelector(".room-description").innerText = roomDescription;

            // ë°©ì¥ì¸ì§€ í™•ì¸ í›„ ë²„íŠ¼ í‘œì‹œ
            if (hostId == currentUser) {
                // í˜¸ìŠ¤íŠ¸ì¼ ë•Œ ìˆ˜ì •, ì‚­ì œ, ë‹«ê¸° ë²„íŠ¼ì„ í‘œì‹œ
                document.querySelector(".room-delete-btn").style.display = "inline-block";
                document.querySelector(".room-edit-btn").style.display = "inline-block";
                document.querySelector(".room-leave-btn").style.display = "none";
            } else {
                // ì¼ë°˜ ì‚¬ìš©ìì¼ ë•Œ ë‚˜ê°€ê¸°, ë‹«ê¸° ë²„íŠ¼ì„ í‘œì‹œ
                document.querySelector(".room-delete-btn").style.display = "none";
                document.querySelector(".room-edit-btn").style.display = "none";
                document.querySelector(".room-leave-btn").style.display = "inline-block";
            }

            roomInfoModal.show();

            // ì±„íŒ…ë°© ì‚­ì œ
            document.querySelector(".room-delete-btn").addEventListener("click",
                function (e) {
                    deleteRoom(roomId)
                        .then(result => {
                            alert("ì±„íŒ…ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            roomInfoModal.hide();
                            location.reload();
                        })
                        .catch((e) => {
                            alert("ì±„íŒ…ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        });
                },false);

            // ì±„íŒ…ë°© ë‚˜ê°€ê¸°
            document.querySelector(".room-leave-btn").addEventListener("click",
                function (e){
                    const chatingRoomDTO = {
                        roomId:roomId,
                        title: roomTitle,
                        description: roomDescription,
                        maxParticipants: maxParticipants,
                        currentParticipants: currentParticipants,
                        status: status
                    };
                    const chatRoomParticipantsDTO = {
                        chatRoomId:roomId,
                        senderId: currentUser
                    };
                    const exitObj = {
                        chatingRoomDTO: chatingRoomDTO,
                        chatRoomParticipantsDTO: chatRoomParticipantsDTO
                    };
                    exitUser(exitObj)
                        .then(result => {
                            alert(result+"ë‹˜ì´ ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
                            roomInfoModal.hide();
                            location.reload();
                        })
                        .catch(e => {
                            console.log("ë°©ì„ ë‚˜ê°€ëŠ” ê³¼ì •ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•¨")
                            alert("ë°©ì„ ë‚˜ê°€ëŠ” ê³¼ì •ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•¨");
                        });
            })

            // ìˆ˜ì • ëª¨ë‹¬
            const editModal = new bootstrap.Modal(document.querySelector(".editModal"));
            const editBtn = document.querySelector(".editBtn");
            const editCloseBtn = document.querySelector(".editCloseBtn");

            const editTitle = document.querySelector(".edit-title");
            const editDescription = document.querySelector(".edit-description");
            const editMaxParticipants = document.querySelector(".edit-maxParticipants");
            const editStatus = document.querySelector(".edit-status");

            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelector(".room-edit-btn").addEventListener("click", function () {
                console.log("ìˆ˜ì • ë²„íŠ¼ í´ë¦­");

                // ê¸°ì¡´ ê°’ ê°€ì ¸ì˜¤ê¸°
                editTitle.value = document.querySelector(".room-title").innerText;
                editDescription.value = document.querySelector(".room-description").innerText;
                editMaxParticipants.value = document.querySelector(".room-participants").innerText.split(" / ")[1];
                editStatus.value = status;

                editModal.show();
            });

            editBtn.addEventListener("click", function () {
                const updatedRoom = {
                    roomId:roomId,
                    title: editTitle.value,
                    description: editDescription.value,
                    maxParticipants: editMaxParticipants.value,
                    status: editStatus.value
                };

                // ë°© ìˆ˜ì • API í˜¸ì¶œ
                UpdateRoom(updatedRoom)
                    .then(result => {
                        alert("ì±„íŒ…ë°©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        editModal.hide();
                        location.reload();
                    })
                    .catch(e => {
                        alert("ì±„íŒ…ë°© ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    });
            },false);

            editCloseBtn.addEventListener("click", function () {
                editModal.hide();
            });
        });
    });

    // ì±„íŒ…ë°© í´ë¦­ ì‹œ roomId ì €ì¥ ë° ì¤‘ë³µ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
    let currentRoomId = null;
    let refreshInterval = null; // Interval ID ì €ì¥ ë³€ìˆ˜

    //ì„ íƒí•œ ë°© ì •ë³´
    let currentRoomInfo = null;

    document.querySelectorAll(".chat-preview").forEach(chatPreview => {
        chatPreview.addEventListener("click", function () {
            const newRoomId = this.closest(".chatInfo").querySelector("h4:nth-of-type(1)").innerText.trim();

            // í˜„ì¬ ë°©ê³¼ ë‹¤ë¥¸ ë°©ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ì²˜ë¦¬
            if (currentRoomId !== newRoomId) {
                currentRoomId = newRoomId;
                console.log(`ë°© ë²ˆí˜¸: ${currentRoomId}`);

                // ë°© ì •ë³´ ì´ˆê¸°í™” ë° ìƒˆë¡œìš´ ì •ë³´ë¡œ ì„¤ì •
                currentRoomInfo = {
                    roomId: newRoomId,
                    roomTitle: this.closest(".chatInfo").querySelector("h4:nth-of-type(3)").innerText,
                    hostId: this.closest(".chatInfo").querySelector("h4:nth-of-type(2)").innerText,
                    currentParticipants: this.closest(".chatInfo").querySelector("h4:nth-of-type(5)").innerText,
                    maxParticipants: this.closest(".chatInfo").querySelector("h4:nth-of-type(6)").innerText,
                };

                console.log("í˜„ì¬ ë°© ì •ë³´:", currentRoomInfo);
                // ì´ì „ Interval ì œê±°
                if (refreshInterval !== null) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }

                // ì±„íŒ… ë©”ì‹œì§€ ë¡œë“œ
                loadChatMessages(currentRoomId);

                // ìƒˆë¡œìš´ Interval ì„¤ì •
                refreshInterval = setInterval(function () {
                    loadChatMessages(currentRoomId);
                }, 5000);
            }
        });
    });

    // ì±„íŒ… ë‚´ì—­ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function loadChatMessages(roomId) {
        console.log(`ì±„íŒ…ë°© ${roomId}ì˜ ë©”ì‹œì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);

        // getChatList í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ í•´ë‹¹ roomIdì˜ ì±„íŒ… ë©”ì‹œì§€ ëª©ë¡ì„ ê°€ì ¸ì˜´
        getChatList(roomId)
            .then(result => {
                // ì±„íŒ… ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  DOM ìš”ì†Œë¥¼ ê°€ì ¸ì˜´
                const chatMessages = document.getElementById("chatMessages");
                // ê¸°ì¡´ì˜ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì—¬ ìƒˆë¡œìš´ ë©”ì‹œì§€ë“¤ë¡œ ê°±ì‹  ì¤€ë¹„
                chatMessages.innerHTML = "";

                // ê°€ì ¸ì˜¨ ì±„íŒ… ë©”ì‹œì§€ë“¤ì„ ì—­ìˆœìœ¼ë¡œ ì²˜ë¦¬ (ìµœì‹  ë©”ì‹œì§€ê°€ ì•„ë˜ì— ìœ„ì¹˜í•˜ë„ë¡)
                result.reverse().forEach(chatMessage => {
                    // ê° ë©”ì‹œì§€ì— ëŒ€í•´ ìƒˆë¡œìš´ div ìš”ì†Œë¥¼ ìƒì„±
                    const messageDiv = document.createElement('div');
                    // ë©”ì‹œì§€ì˜ ìŠ¤íƒ€ì¼ì„ ì§€ì • (ë³¸ì¸ ë©”ì‹œì§€ëŠ” 'user' í´ë˜ìŠ¤, ë‹¤ë¥¸ ì‚¬ëŒ ë©”ì‹œì§€ëŠ” 'other' í´ë˜ìŠ¤)
                    messageDiv.classList.add('message', chatMessage.senderId === currentUser ? 'user' : 'other');

                    // ë©”ì‹œì§€ ë‚´ìš©ê³¼ ë°œì‹ ì ì´ë¦„ì„ í¬í•¨í•œ HTMLì„ ìƒì„±
                    messageDiv.innerHTML = `
                    ${chatMessage.senderId !== currentUser ? `<div class="sender-name"><strong>${chatMessage.senderName}</strong></div>` : ''}
                    <div class="message-content">${chatMessage.content}</div>`;

                    // ë³¸ì¸ì˜ ë©”ì‹œì§€ì— ëŒ€í•´ì„œë§Œ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€
                    if (chatMessage.senderId === currentUser) {
                        messageDiv.addEventListener('click', () => {
                            // í´ë¦­ëœ ë©”ì‹œì§€ì˜ messageIdë¥¼ ì½˜ì†”ì— ì¶œë ¥
                            console.log("ì‚­ì œí•  messageId" + chatMessage.messageId);

                            // ì‚­ì œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” í™•ì¸ì°½ì„ ë„ì›€
                            const confirmDelete = confirm("ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

                            // ì‚¬ìš©ìê°€ 'í™•ì¸'ì„ ëˆ„ë¥´ë©´ ë©”ì‹œì§€ë¥¼ ì‚­ì œ
                            if (confirmDelete) {
                                // deleteMessage í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì‚­ì œ
                                deleteMessage(chatMessage.messageId)
                                    .then(response => {
                                        // ì‚­ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì¡Œìœ¼ë©´
                                        if (response.messageId === chatMessage.messageId) {
                                            console.log("ë©”ì‹œì§€ ì‚­ì œ ì„±ê³µ");
                                            // ë©”ì‹œì§€ ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•´ loadChatMessagesë¥¼ ë‹¤ì‹œ í˜¸ì¶œ
                                            loadChatMessages(roomId);
                                        }
                                    })
                                    .catch(err => {
                                        // ì‚­ì œ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš°
                                        console.error("ë©”ì‹œì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
                                        alert("ë©”ì‹œì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                                    });
                            }
                        });
                    }
                    // ë©”ì‹œì§€ë¥¼ chatMessages DOMì— ì¶”ê°€
                    chatMessages.appendChild(messageDiv);
                });

                // ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ì˜ ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ìë™ìœ¼ë¡œ ì´ë™ì‹œì¼œ ìµœì‹  ë©”ì‹œì§€ê°€ ë³´ì´ê²Œ í•¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(e => {
                // ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²½ìš°
                alert("ì±„íŒ… ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            });
    }


    // ë©”ì‹œì§€ ì „ì†¡ ë° ì±„íŒ… ìƒˆë¡œê³ ì¹¨
    document.querySelector("#sendMessageButton").addEventListener("click", sendMessage);
    document.querySelector("#chatMessageInput").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {  // ì—”í„° í‚¤ê°€ ëˆŒë ¸ì„ ë•Œ
            event.preventDefault();  // ê¸°ë³¸ ë™ì‘ì¸ ì¤„ ë°”ê¿ˆì„ ë°©ì§€
            sendMessage();
        }
    });

    async function sendMessage() {
        if (!currentRoomId) {
            return alert("ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        }

        const messageInput = document.querySelector("#chatMessageInput");
        const messageContent = messageInput.value.trim();
        if (messageContent === "") return alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const messageObj = {
            senderId: currentUser,
            content: messageContent,
            chatRoomId: currentRoomId
        };

        addMessage(messageObj)
            .then(() => {
                messageInput.value = "";  // ë©”ì‹œì§€ ì…ë ¥ì°½ ì´ˆê¸°í™”
                loadChatMessages(currentRoomId);  // ì±„íŒ… ìƒˆë¡œê³ ì¹¨
            })
            .catch(e => alert("ë©”ì‹œì§€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ"));
    }


    // ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬ ì²˜ë¦¬
    const inviteModal = new bootstrap.Modal(document.querySelector(".inviteModal")); // ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬ ì°½ ì´ˆê¸°í™”
    const inviteButton = document.querySelector("#inviteButton"); // ì¹œêµ¬ ì´ˆëŒ€ ë²„íŠ¼
    const inviteBtn = document.querySelector(".inviteBtn"); // ì´ˆëŒ€ ë²„íŠ¼
    const searchInput = document.querySelector("#searchUser"); // ê²€ìƒ‰ ì…ë ¥ í•„ë“œ
    const friendListContainer = document.querySelector(".friend-list"); // ì¹œêµ¬ ëª©ë¡ ì»¨í…Œì´ë„ˆ

    inviteButton.addEventListener("click", function () {
        console.log("ì¹œêµ¬ ì´ˆëŒ€ í´ë¦­");
        inviteModal.show();
        // ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸°
        fetchUserList();
    });

    // ì´ˆëŒ€ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    inviteBtn.addEventListener("click", function () {
        const selectedUsers = Array.from(
            document.querySelectorAll('.friend-item input[type="checkbox"]:checked')
        ).map(checkbox => checkbox.value);

        console.log("ì„ íƒëœ ìœ ì € IDë“¤:", selectedUsers);

        if (selectedUsers.length === 0) {
            alert("ì´ˆëŒ€í•  ìœ ì €ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        // í˜„ì¬ ë°©ì˜ ì°¸ê°€ ê°€ëŠ¥í•œ ìŠ¬ë¡¯ê³¼ ì„ íƒëœ ì¸ì› ìˆ˜ í™•ì¸
        console.log("í˜„ì¬ ì±„íŒ…ë°© ì •ë³´:", currentRoomInfo);

        const availableSlots = currentRoomInfo.maxParticipants - currentRoomInfo.currentParticipants;

        if (selectedUsers.length > availableSlots) {
            alert("ìµœëŒ€ " + availableSlots + "ëª…ê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ì„ íƒëœ ì¸ì›: " + selectedUsers.length + "ëª…)");
            return;
        }

        //ì´ˆëŒ€í•  ìœ ì € ì •ë³´
        const inviteObj = selectedUsers.map(mid => ({
            chatingRoomDTO: {
                roomId: currentRoomId,
                currentParticipants: currentRoomInfo.currentParticipants,
                maxParticipants: currentRoomInfo.maxParticipants
            },
            chatRoomParticipantsDTO: {
                chatRoomId: currentRoomId,
                senderId: mid
            }
        }));

        console.log("ì´ˆëŒ€í•  ìœ ì € ëª©ë¡:", inviteObj);

        inviteUser(inviteObj)
            .then(result => {
                alert("ì´ˆëŒ€ë¥¼ ì™„ë£Œ í–ˆìŠµë‹ˆë‹¤.");
                location.reload();
            })
            .catch(e => alert("ì´ˆëŒ€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"));
    });


    // ìœ ì € ê²€ìƒ‰
    searchInput.addEventListener("input", function () {
        const keyword = searchInput.value.trim();
        console.log("ê²€ìƒ‰ì–´1 :", keyword);
        fetchUserList(keyword);  // ê²€ìƒ‰ í‚¤ì›Œë“œì— ë”°ë¼ ìœ ì € ëª©ë¡ ê°±ì‹ 
    });


    // ìœ ì € ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function fetchUserList(keyword) {
        if (!currentRoomId) {
            return alert("ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        }
        try {
            const userList = await getUserListInvite(currentRoomId, keyword);
            console.log("ë°›ì•„ì˜¨ ìœ ì € ëª©ë¡:", userList);
            renderUserList(userList);
        } catch (error) {
            console.error("ìœ ì € ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
    }

    // ìœ ì € ëª©ë¡ ë Œë”ë§
    let selectedUsers2 = []; // ì„ íƒëœ ìœ ì € IDë¥¼ ì €ì¥í•˜ëŠ” ë°°ì—´

    function renderUserList(userList) {
        friendListContainer.innerHTML = "";

        if (userList.length === 0) {
            friendListContainer.innerHTML = '<p class="text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        userList.forEach(user => {
            const isChecked = selectedUsers2.includes(user.mid); // ì„ íƒ ì—¬ë¶€ í™•ì¸
            const userItem = document.createElement("div");
            userItem.classList.add("friend-item");
            userItem.innerHTML = `
            <input type="checkbox" id="friend-${user.mid}" value="${user.mid}" ${isChecked ? "checked" : ""}>
            <label for="friend-${user.mid}">${user.name}</label>
        `;
            friendListContainer.appendChild(userItem);
        });

        // ì²´í¬ë°•ìŠ¤ ì„ íƒ ì´ë²¤íŠ¸
        friendListContainer.querySelectorAll("input[type='checkbox']").forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                const userId = this.value;
                if (this.checked) {
                    console.log("ì„ íƒí•œ ìœ ì € ì •ë³´ :", userId);
                    if (!selectedUsers2.includes(userId)) {
                        selectedUsers2.push(userId);
                    }
                } else {
                    console.log("ì„ íƒ í•´ì œí•œ ìœ ì € ì •ë³´ :", userId);
                    selectedUsers2 = selectedUsers2.filter(id => id !== userId);
                }
            });
        });
    }
</script>
</body>
</html>
